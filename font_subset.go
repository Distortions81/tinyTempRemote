package main

import "tinygo.org/x/drivers/ssd1306"

type fontGlyph struct {
	rune    rune
	width   uint8
	height  uint8
	advance uint8
	xOffset int8
	yOffset int8
	bitmap  []byte
}

var fontGlyphTable map[rune]*fontGlyph

func init() {
	glyphs := []fontGlyph{
		{rune: 48, width: 11, height: 17, advance: 13, xOffset: 1, yOffset: -16, bitmap: []byte{
			0x1F, 0x07, 0xF1, 0xC7, 0x30, 0x6E, 0x0F, 0x80, 0xF0, 0x1E, 0x03, 0xC0,
			0x78, 0x0F, 0x01, 0xE0, 0x3C, 0x0E, 0xC1, 0x9C, 0x71, 0xFC, 0x1F, 0x00,
		}},
		{rune: 49, width: 5, height: 17, advance: 13, xOffset: 3, yOffset: -16, bitmap: []byte{
			0x08, 0xCF, 0xFF, 0x8C, 0x63, 0x18, 0xC6, 0x31, 0x8C, 0x63, 0x18,
		}},
		{rune: 50, width: 11, height: 17, advance: 13, xOffset: 1, yOffset: -16, bitmap: []byte{
			0x1F, 0x0F, 0xF9, 0x87, 0x60, 0x7C, 0x06, 0x00, 0xC0, 0x18, 0x07, 0x01,
			0xC0, 0xF0, 0x78, 0x1C, 0x06, 0x00, 0x80, 0x30, 0x07, 0xFF, 0xFF, 0xE0,
		}},
		{rune: 51, width: 11, height: 17, advance: 13, xOffset: 1, yOffset: -16, bitmap: []byte{
			0x3F, 0x0F, 0xF3, 0x87, 0x60, 0x6C, 0x0C, 0x01, 0x80, 0x70, 0x7C, 0x0F,
			0x80, 0x18, 0x01, 0x80, 0x3C, 0x07, 0x80, 0xD8, 0x73, 0xFC, 0x1F, 0x00,
		}},
		{rune: 52, width: 11, height: 17, advance: 13, xOffset: 1, yOffset: -16, bitmap: []byte{
			0x01, 0x80, 0x70, 0x0E, 0x03, 0xC0, 0xD8, 0x1B, 0x06, 0x61, 0x8C, 0x21,
			0x8C, 0x33, 0x06, 0x7F, 0xFF, 0xFE, 0x03, 0x00, 0x60, 0x0C, 0x01, 0x80,
		}},
		{rune: 53, width: 11, height: 17, advance: 13, xOffset: 1, yOffset: -16, bitmap: []byte{
			0x3F, 0xCF, 0xF9, 0x80, 0x30, 0x06, 0x00, 0xDE, 0x1F, 0xE7, 0x0E, 0x00,
			0xE0, 0x0C, 0x01, 0x80, 0x30, 0x07, 0x81, 0xF8, 0x73, 0xFC, 0x1F, 0x00,
		}},
		{rune: 54, width: 11, height: 17, advance: 13, xOffset: 1, yOffset: -16, bitmap: []byte{
			0x0F, 0x07, 0xF9, 0xC3, 0x30, 0x74, 0x01, 0x80, 0x33, 0xC7, 0xFE, 0xF0,
			0xDC, 0x1F, 0x01, 0xE0, 0x3C, 0x06, 0xC1, 0xDC, 0x71, 0xFC, 0x1F, 0x00,
		}},
		{rune: 55, width: 11, height: 17, advance: 13, xOffset: 1, yOffset: -16, bitmap: []byte{
			0xFF, 0xFF, 0xFC, 0x01, 0x00, 0x60, 0x18, 0x02, 0x00, 0xC0, 0x30, 0x06,
			0x01, 0x80, 0x30, 0x04, 0x01, 0x80, 0x30, 0x06, 0x01, 0x80, 0x30, 0x00,
		}},
		{rune: 56, width: 11, height: 17, advance: 13, xOffset: 1, yOffset: -16, bitmap: []byte{
			0x1F, 0x07, 0xF1, 0xC7, 0x30, 0x66, 0x0C, 0xC1, 0x8C, 0x61, 0xFC, 0x3F,
			0x8E, 0x3B, 0x01, 0xE0, 0x3C, 0x07, 0x80, 0xD8, 0x31, 0xFC, 0x1F, 0x00,
		}},
		{rune: 57, width: 11, height: 17, advance: 13, xOffset: 1, yOffset: -16, bitmap: []byte{
			0x1F, 0x07, 0xF1, 0xC7, 0x70, 0x6C, 0x07, 0x80, 0xF0, 0x1E, 0x07, 0x61,
			0xEF, 0xFC, 0x79, 0x80, 0x30, 0x05, 0x81, 0x98, 0x73, 0xFC, 0x1E, 0x00,
		}},
		{rune: 46, width: 2, height: 2, advance: 6, xOffset: 2, yOffset: -1, bitmap: []byte{
			0xF0,
		}},
		{rune: 70, width: 11, height: 18, advance: 14, xOffset: 2, yOffset: -17, bitmap: []byte{
			0xFF, 0xFF, 0xFF, 0x00, 0x60, 0x0C, 0x01, 0x80, 0x30, 0x06, 0x00, 0xFF,
			0xDF, 0xFB, 0x00, 0x60, 0x0C, 0x01, 0x80, 0x30, 0x06, 0x00, 0xC0, 0x18,
			0x00,
		}},
		{rune: 32, width: 0, height: 0, advance: 6, xOffset: 0, yOffset: 1, bitmap: []byte{}},
	}

	fontGlyphTable = make(map[rune]*fontGlyph, len(glyphs))
	for i := range glyphs {
		g := glyphs[i]
		fontGlyphTable[g.rune] = &glyphs[i]
	}
}

func getGlyph(r rune) *fontGlyph {
	if g, ok := fontGlyphTable[r]; ok {
		return g
	}
	return fontGlyphTable[' ']
}

func textPixelWidth(s string) int16 {
	var width int16
	for _, r := range s {
		g := getGlyph(r)
		width += int16(g.advance)
	}
	return width
}

func drawText(display *ssd1306.Device, x, y int16, text string) {
	for _, r := range text {
		g := getGlyph(r)
		drawGlyph(display, x, y, g)
		x += int16(g.advance)
	}
}

func drawGlyph(display *ssd1306.Device, baseX, baseY int16, glyph *fontGlyph) {
	if glyph == nil {
		return
	}
	bitmapOffset := 0
	var bitmap byte
	if len(glyph.bitmap) > 0 {
		bitmap = glyph.bitmap[bitmapOffset]
	}
	var bit uint8
	for j := int16(0); j < int16(glyph.height); j++ {
		for i := int16(0); i < int16(glyph.width); i++ {
			if (bitmap & 0x80) != 0 {
				setPixel(display, baseX+int16(glyph.xOffset)+i, baseY+int16(glyph.yOffset)+j, true)
			}
			bitmap <<= 1
			bit++
			if bit > 7 {
				bitmapOffset++
				if bitmapOffset < len(glyph.bitmap) {
					bitmap = glyph.bitmap[bitmapOffset]
				} else {
					bitmap = 0
				}
				bit = 0
			}
		}
	}
}

func setPixel(display *ssd1306.Device, x, y int16, on bool) {
	if x < 0 || x >= int16(displayWidth) || y < 0 || y >= int16(displayHeight) {
		return
	}
	buf := display.GetBuffer()
	width := int16(displayWidth)
	index := int(x + (y/8)*width)
	mask := byte(1 << (uint8(y) & 7))
	if on {
		buf[index] |= mask
	} else {
		buf[index] &^= mask
	}
}
